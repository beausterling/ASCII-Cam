---
phase: 02-webcam-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/webcam.js
  - index.html
  - css/style.css
autonomous: true

must_haves:
  truths:
    - "User sees a Start Camera button on page load"
    - "Clicking Start Camera requests webcam permission via browser prompt"
    - "User receives a clear error message if permission denied or camera unavailable"
    - "User sees a camera switch button on mobile devices"
    - "Switching cameras stops old stream tracks before starting new stream"
  artifacts:
    - path: "js/webcam.js"
      provides: "Camera initialization, switching, error handling, stream cleanup"
      exports: ["initCamera", "switchCamera", "stopCamera", "getCapture", "isCameraReady"]
    - path: "index.html"
      provides: "Start Camera button, Switch Camera button, error message area, status area"
      contains: "btn-start-camera"
    - path: "css/style.css"
      provides: "Styles for camera controls and error/status messages"
      contains: ".camera-controls"
  key_links:
    - from: "js/webcam.js"
      to: "p5.createCapture"
      via: "getUserMedia constraints with ideal 320x240"
      pattern: "createCapture"
    - from: "js/webcam.js"
      to: "navigator.mediaDevices"
      via: "HTTPS detection and error handling"
      pattern: "mediaDevices"
---

<objective>
Create the webcam.js module with camera initialization, front/rear switching, comprehensive error handling, and add the UI controls (buttons, error display) to the HTML page.

Purpose: Establishes the camera access layer that all subsequent phases depend on. Users need a clear way to start the camera, see errors, and switch cameras on mobile.

Output: js/webcam.js module, updated index.html with camera UI, updated css/style.css with control styles.
</objective>

<execution_context>
@/Users/beausterling/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beausterling/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-webcam-capture/02-RESEARCH.md
@js/config.js
@index.html
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webcam.js module with camera init, switching, and error handling</name>
  <files>js/webcam.js</files>
  <action>
Create a new ES module `js/webcam.js` that manages all camera operations. This is a vanilla JS static site using CDN p5.js (no npm, no build step). p5.js functions like `createCapture` are available as globals.

The module must export these functions:

**initCamera(facingMode):**
- Takes optional facingMode parameter (default "user")
- First checks `navigator.mediaDevices` exists (HTTPS check). If not, return error object with message about HTTPS requirement
- Calls p5.js `createCapture()` with constraints: `{ video: { width: { ideal: 320 }, height: { ideal: 240 }, facingMode: facingMode }, audio: false }`
- Calls `capture.hide()` to hide the default video element p5 creates
- Sets a module-level `cameraReady` flag to true on success callback
- On error, calls internal `handleCameraError(err)` which maps error names to user-friendly messages (see RESEARCH.md Pattern 4 for the 6 error types: NotAllowedError, NotFoundError, NotReadableError, OverconstrainedError, TypeError, PermissionDismissedError plus their legacy aliases)
- Returns an object: `{ success: boolean, error: string|null }`
- Use async/await with navigator.mediaDevices.getUserMedia for error handling, then pass stream to createCapture

**switchCamera():**
- Calls `stopCamera()` first to clean up existing stream
- Toggles module-level `currentFacing` between "user" and "environment"
- Calls `initCamera(currentFacing)` with the new facing mode
- IMPORTANT: When switching, use `{ exact: currentFacing }` for facingMode (not just the string) so the browser is forced to use the requested camera
- Returns the result of initCamera

**stopCamera():**
- If capture exists and has srcObject, get all tracks via `capture.elt.srcObject.getTracks()` and call `track.stop()` on each
- Set `capture.elt.srcObject = null`
- Call `capture.remove()` to clean up the p5 element
- Reset `cameraReady` to false
- Guard all operations with null checks (safe to call when no camera active)

**getCapture():** Returns the current p5 capture element (or null)

**isCameraReady():** Returns the cameraReady boolean

**handleCameraError(err):** (internal, not exported)
- Maps err.name to user-friendly messages using a plain object lookup (see RESEARCH.md error handling pattern)
- Returns the user-friendly message string
- Console.error the original error for debugging

Module-level state variables: `capture` (p5.MediaElement|null), `cameraReady` (boolean), `currentFacing` (string "user"|"environment")

Include thorough inline comments in natural student voice explaining:
- Why we use ideal constraints instead of exact
- Why we must stop tracks before switching cameras (Android Chrome issue)
- Why HTTPS is required for getUserMedia
- What facingMode "user" vs "environment" means

Do NOT use p5 instance mode -- p5.js is loaded globally via CDN script tag, so createCapture and other p5 functions are globals.
  </action>
  <verify>
Verify the file exists and has correct structure:
- `grep -c "export" js/webcam.js` returns 5 (initCamera, switchCamera, stopCamera, getCapture, isCameraReady)
- `grep "createCapture" js/webcam.js` finds usage
- `grep "ideal.*320" js/webcam.js` confirms low-resolution constraints
- `grep "track.stop" js/webcam.js` confirms stream cleanup
- `grep "NotAllowedError" js/webcam.js` confirms error handling
- `npm run lint` passes with no errors (warnings OK for unused vars)
  </verify>
  <done>
js/webcam.js exports initCamera, switchCamera, stopCamera, getCapture, and isCameraReady. Camera initializes with 320x240 ideal constraints. All 6 getUserMedia error types handled with user-friendly messages. Stream tracks properly stopped before camera switching. HTTPS check present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add camera UI controls and styles to HTML page</name>
  <files>index.html, css/style.css</files>
  <action>
**index.html changes:**

Replace the current body content (the logo container) with a layout that includes camera controls. Keep the figlet logo but add below it:

1. A camera controls section with id="camera-controls" and class="camera-controls":
   - A "Start Camera" button: `<button id="btn-start-camera" class="btn btn-success btn-lg">Start Camera</button>`
   - A "Switch Camera" button: `<button id="btn-switch-camera" class="btn btn-outline-secondary" style="display: none;">Switch Camera</button>` (hidden by default, shown on mobile or when multiple cameras detected)
   - These should be inside a `<div class="d-flex gap-2 justify-content-center flex-wrap">` for nice layout

2. A status message area: `<div id="camera-status" class="camera-status text-center mt-2"></div>` -- for showing "Initializing camera..." type messages

3. An error message area: `<div id="camera-error" class="camera-error text-center mt-2" style="display: none;"></div>` -- for showing error messages in red/warning style, hidden by default

4. A canvas container: `<div id="canvas-container" class="canvas-container text-center mt-3"></div>` -- where the p5.js canvas will be placed in Plan 02

Keep the `<pre id="logo">` element at top. Keep the Bootstrap container structure. The layout order should be: logo, camera controls, status, error, canvas container.

Do NOT add any JavaScript to index.html -- all logic goes in JS modules. The button click handlers will be wired in Plan 02 via main.js.

**css/style.css changes:**

Add styles below existing rules:

- `.camera-controls`: margin-top 1rem, text-align center
- `.camera-status`: color #aaa (muted gray), font-size 0.9rem, min-height 1.5em (prevents layout shift)
- `.camera-error`: color #ff6b6b (soft red), background rgba(255,0,0,0.1), border 1px solid rgba(255,0,0,0.3), border-radius 0.5rem, padding 0.75rem 1rem, font-size 0.9rem, max-width 400px, margin 0 auto
- `.canvas-container`: min-height 200px (placeholder space for canvas)
- `#btn-start-camera`: No extra styles needed (Bootstrap btn-success is fine)

Update the body CSS to remove `display: flex; align-items: center; justify-content: center;` since we no longer want vertical centering (content will grow as camera loads). Replace with: `padding-top: 2rem;`

Include student-voice comments explaining the styling choices.

Run `npm run format` after making changes to ensure Prettier formatting.
  </action>
  <verify>
- Open index.html and confirm it contains: btn-start-camera, btn-switch-camera, camera-status, camera-error, canvas-container
- `grep "btn-start-camera" index.html` finds the button
- `grep "camera-controls" css/style.css` finds the styles
- `grep "camera-error" css/style.css` finds error styles
- `npm run lint` passes
- `npm run format:check` passes (or run format first)
  </verify>
  <done>
index.html contains Start Camera button, Switch Camera button (hidden), status area, error area, and canvas container. CSS has styles for all camera UI elements. Body no longer vertically centers (ready for growing content). All Prettier-formatted.
  </done>
</task>

</tasks>

<verification>
1. js/webcam.js exists with 5 exported functions
2. index.html has all UI elements (buttons, status, error, canvas container)
3. css/style.css has camera control styles
4. `npm run lint` passes (warnings OK)
5. `npm run format:check` passes
6. No new CDN dependencies added (pure p5.js + browser APIs)
</verification>

<success_criteria>
- webcam.js module created with camera init (320x240 ideal constraints), camera switching (with track cleanup), error handling (6 error types), and HTTPS detection
- HTML page has Start Camera button, Switch Camera button, status/error display areas, and canvas container
- All code has student-voice inline comments
- Lint and format checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-webcam-capture/02-01-SUMMARY.md`
</output>
